<!DOCTYPE HTML>
<head>
	<meta charset='utf-8'>
	<link rel='stylesheet' href='http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css'/>
	<style>
		body {
			margin:0;
			padding:0;
		}

		#map {
			position:relative;
			height:100vh;
		}
	</style>
</head>
<body>
	<div id='map'></div>
	<script src='http://d3js.org/d3.v3.min.js'></script>
	<script src='http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js'></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src='//api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js'></script>
	<script>
		// initialize
		var map = L.map('map').setView([40.692191, -73.972732], 13);

		L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
		    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
		}).addTo(map);

		// load geojsons
		queue()
			.defer(d3.json, 'cd.geojson')
			.defer(d3.json, 'spills.geojson')
			.await(function(err,cd,spills){
				countPoints(cd,spills);
				loadCd(cd);
				loadSpills(spills);
			})

		function countPoints(polygons,points){
			var polygons = polygons,
				points = points;

			// add counts to polygon
			turf.count(polygons, points, 'pt_count');
		}

		function loadCd(data){
			var polygon = {
				fillColor:'#fff',
				weight:0.8,
				fillOpacity:0.5
			};

			var cd = L.geoJson(data, {
				style: polygon,
				onEachFeature: function(feature,layer){
					layer.bindPopup('Spill incidents in CD ' + feature.properties.borocd + ': ' + feature.properties.pt_count);
				}
			}).addTo(map);
		}

		function loadSpills(data){

			// circle marker
			var circleAmount = {
				radius: 3,
				fillColor: '#f00',
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.8
			};

			var circleUnknown = {
				radius: 3,
				fillColor: '#111',
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.8	
			};

			var spills = L.geoJson(data, {
				pointToLayer: function(feature,latlng){
					if (feature.properties.Amount != 'Unknown') {
						return L.circleMarker(latlng, circleAmount)
					} else {
						return L.circleMarker(latlng, circleUnknown)
					}
				}
			}).addTo(map);
		}


	</script>
</body>